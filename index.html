<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YouTube Optimizer + Analytics (Enhanced)</title>
<style>
:root{--bg:#f8fafc;--card:#fff;--muted:#64748b}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;padding:18px;background:var(--bg);color:#0f172a}
.wrap{max-width:980px;margin:12px auto}
h1{font-size:20px;margin:6px 0}
label{display:block;margin-top:12px;font-weight:700;color:var(--muted)}
input,button,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef6;background:var(--card)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1}
.card{background:var(--card);padding:12px;border-radius:12px;border:1px solid #e6eef6;margin-top:12px}
.muted{color:var(--muted)}
.ok{color:green}.warn{color:orange}.err{color:red}
img.thumb{max-width:320px;border-radius:8px;margin-top:8px}
pre{background:#0b1220;color:#e6eef6;padding:10px;border-radius:8px;overflow:auto}
.btn-inline{display:inline-block;padding:8px 12px;border-radius:8px;background:#0ea5a9;color:white;border:none;cursor:pointer;margin:3px}
.btn-selected{background:#facc15;color:#0f172a;}
.small{font-size:13px;color:var(--muted)}
table{border-collapse:collapse;width:100%;margin-top:12px}
th,td{border:1px solid #e6eef6;padding:6px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
<h1>YouTube Trend Optimizer + Detailed Analytics</h1>

<div class="card">
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <div style="flex:1;min-width:220px">
      <label>OAuth Client ID</label>
      <input id="clientId" placeholder="ENTER_YOUR_CLIENT_ID.apps.googleusercontent.com" />
      <div class="small">Google Cloud â†’ OAuth 2.0 Client ID (Web app). Add this page origin as Authorized JS origin.</div>
    </div>
    <div style="min-width:220px"><label>&nbsp;</label><button id="authBtn" class="btn-inline">Sign in / Grant Access</button></div>
    <div style="min-width:220px"><label>&nbsp;</label><button id="signoutBtn" class="btn-inline" style="background:#ef4444">Sign out</button></div>
  </div>
  <div id="authStatus" class="small muted" style="margin-top:8px">Not signed in</div>
</div>

<div class="card">
  <label>Video URL or ID</label>
  <input id="videoInput" placeholder="https://youtu.be/XXXXX or /shorts/XXXXX or video id" />
  <div class="row" style="margin-top:10px">
    <div class="col"><button id="analyzeBtn" class="btn-inline">Analyze</button></div>
    <div class="col"><button id="clearBtn" class="btn-inline" style="background:#6b7280">Clear</button></div>
  </div>
  <div id="warnings" class="small muted" style="margin-top:8px"></div>
</div>

<div id="results" style="display:none">
  <div class="card"><h3>Summary</h3><div id="summary"></div></div>
  <div class="card"><h3>Metadata</h3><div id="meta"></div></div>
  <div class="card"><h3>Analytics</h3><div id="analytics"></div></div>
  <div class="card"><h3>Select Title</h3><div id="titles"></div></div>
  <div class="card"><h3>Select Description</h3><div id="descriptions"></div></div>
  <div class="card"><h3>Predicted Performance</h3><div id="prediction"></div></div>
  <div class="card"><h3>Raw JSON</h3><pre id="raw"></pre></div>
</div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
const SCOPES = [
  'https://www.googleapis.com/auth/youtube.readonly',
  'https://www.googleapis.com/auth/yt-analytics.readonly'
].join(' ');
let tokenClient=null,accessToken=null,tokenExpiresAt=null,currentClientId='';
const el=id=>document.getElementById(id);

el('authBtn').addEventListener('click',()=>{
  currentClientId=el('clientId').value.trim();
  if(!currentClientId||currentClientId.startsWith('ENTER_')){alert('Enter OAuth Client ID');return;}
  initTokenClient(currentClientId);
  tokenClient.requestAccessToken({prompt:'consent'});
});
el('signoutBtn').addEventListener('click',()=>{
  accessToken=null;tokenExpiresAt=null;
  localStorage.removeItem('yt_aud_token');
  updateAuthUI();
  el('warnings').textContent='Signed out';
});

function updateAuthUI(){
  el('authStatus').innerHTML=(accessToken&&tokenExpiresAt&&Date.now()<tokenExpiresAt)
    ?'Signed in â€” token valid until '+new Date(tokenExpiresAt).toLocaleString()
    :'Not signed in / token expired';
}

function initTokenClient(clientId){
  if(tokenClient&&currentClientId===clientId)return;
  tokenClient=google.accounts.oauth2.initTokenClient({
    client_id:clientId,scope:SCOPES,callback:resp=>{
      if(resp.error){el('warnings').textContent='Token error: '+(resp.error_description||resp.error);return;}
      accessToken=resp.access_token;
      tokenExpiresAt=Date.now()+(resp.expires_in?resp.expires_in*1000:(60*60*1000));
      localStorage.setItem('yt_aud_token',JSON.stringify({token:accessToken,expiresAt:tokenExpiresAt}));
      updateAuthUI();el('warnings').textContent='Access token acquired.';
    }
  });
}

// Restore token
(function(){
  try{
    const saved=JSON.parse(localStorage.getItem('yt_aud_token')||'null');
    if(saved&&saved.token&&saved.expiresAt&&Date.now()<saved.expiresAt){
      accessToken=saved.token;tokenExpiresAt=saved.expiresAt;updateAuthUI();
    }
  }catch(e){}
})();

function extractVideoId(input){
  if(!input)return null;
  input=input.trim();
  const re=/(?:v=|\/videos\/|embed\/|youtu\.be\/|shorts\/)([A-Za-z0-9_-]{11})/;
  const m=input.match(re);
  if(m)return m[1];
  if(/^[A-Za-z0-9_-]{11}$/.test(input))return input;
  return null;
}

el('analyzeBtn').addEventListener('click',async()=>{
  el('warnings').textContent='';el('results').style.display='none';
  const raw=el('videoInput').value.trim();
  const vid=extractVideoId(raw);
  if(!vid){el('warnings').textContent='Invalid video ID';return;}
  if(!accessToken){el('warnings').textContent='No access token';return;}

  try{
    const videoUrl=`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${encodeURIComponent(vid)}`;
    const metaResp=await fetchWithAuth(videoUrl);
    const metaJson=await metaResp.json();
    if(!metaJson.items||!metaJson.items.length){el('warnings').textContent='Video not found';return;}
    const item=metaJson.items[0];

    const end=new Date(),start=new Date();start.setDate(end.getDate()-90);
    const startStr=start.toISOString().slice(0,10),endStr=end.toISOString().slice(0,10);
    const ids='channel==MINE',filters=`video==${vid}`;
    const base=`https://youtubeanalytics.googleapis.com/v2/reports?ids=${ids}&filters=${filters}&startDate=${startStr}&endDate=${endStr}`;

    const metrics='views'; 
    const sourceUrl=`${base}&metrics=${metrics}&dimensions=insightTrafficSourceType`;
    const countryUrl=`${base}&metrics=${metrics}&dimensions=country`;

    const [sourceResp,countryResp]=await Promise.all([fetchWithAuth(sourceUrl),fetchWithAuth(countryUrl)]);
    const trafficJson=sourceResp.ok?await sourceResp.json():{};
    const countryJson=countryResp.ok?await countryResp.json():{};

    renderResults(item,trafficJson,countryJson,{startDate:startStr,endDate:endStr});
    await generateTrendBasedSuggestions(item.snippet.title);
    el('raw').textContent=JSON.stringify({meta:metaJson,traffic:trafficJson,country:countryJson},null,2);
  }catch(err){console.error(err);el('warnings').textContent='Error: '+(err.message||err);}
});

el('clearBtn').addEventListener('click',()=>{
  ['videoInput','warnings','raw','titles','descriptions','prediction'].forEach(id=>el(id).textContent='');
  el('results').style.display='none';
});

async function fetchWithAuth(url){return fetch(url,{headers:{Authorization:'Bearer '+accessToken}});}

function renderResults(metaItem,trafficJson,countryJson,meta){
  el('results').style.display='block';
  const snip=metaItem.snippet||{},stats=metaItem.statistics||{},contentDetails=metaItem.contentDetails||{};
  const isShort=isShortDuration(contentDetails.duration);
  el('summary').innerHTML=`<strong>Title:</strong> ${escapeHtml(snip.title)}<br>
  <strong>Video ID:</strong> ${metaItem.id}<br>
  <strong>Type:</strong> ${isShort?'Short (<=60s)':'Regular video'}<br>
  <strong>Date range:</strong> ${meta.startDate} â†’ ${meta.endDate}`;
  const thumb=snip.thumbnails&&(snip.thumbnails.maxres||snip.thumbnails.high||snip.thumbnails.medium||snip.thumbnails.default);
  el('meta').innerHTML=`<div style="display:flex;gap:12px;flex-wrap:wrap">
    <div style="flex:1;min-width:240px"><strong>Title</strong><br>${escapeHtml(snip.title)}<br><br>
    <strong>Description</strong><br>${escapeHtml((snip.description||'').slice(0,200))}</div>
    <div style="min-width:320px"><strong>Thumbnail</strong><br>${thumb?`<img class="thumb" src="${thumb.url}">`:'<div class="warn">No thumbnail</div>'}</div></div>
    <div style="margin-top:12px"><strong>Stats:</strong> Views: ${stats.viewCount||0} â€¢ Likes: ${stats.likeCount||0} â€¢ Comments: ${stats.commentCount||0}</div>`;

  // Traffic sources
  let analyticsHtml='<h4>Traffic Sources</h4>';
  if(trafficJson.rows){
    analyticsHtml+=`<table><tr><th>Source</th><th>Views</th></tr>`;
    trafficJson.rows.forEach(r=>{
      const src=prettySource(r[0]);
      analyticsHtml+=`<tr><td>${src}</td><td>${r[1]}</td></tr>`;
    });
    analyticsHtml+='</table>';
  }else analyticsHtml+='<div class="warn">No traffic source data</div>';

  analyticsHtml+='<h4>Countries</h4>';
  if(countryJson.rows){
    analyticsHtml+=`<table><tr><th>Country</th><th>Views</th></tr>`;
    countryJson.rows.forEach(r=>{
      analyticsHtml+=`<tr><td>${countryName(r[0])}</td><td>${r[1]}</td></tr>`;
    });
    analyticsHtml+='</table>';
  }else analyticsHtml+='<div class="warn">No country data</div>';

  el('analytics').innerHTML=analyticsHtml;
}

// Country + Source mappings
function countryName(code){return new Intl.DisplayNames(['en'],{type:'region'}).of(code)||code;}
function prettySource(code){
  const map={
    SHORTS:'YouTube Shorts feed',YT_SEARCH:'YouTube Search',NO_LINK_OTHER:'External',SUBSCRIBER:'Subscribers',
    YT_OTHER_PAGE:'Other YouTube pages',CHANNEL:'Channel page',PLAYLIST:'Playlist',NOTIFICATION:'Notifications',
    RELATED_VIDEO:'Suggested videos',EXT_URL:'External sites'
  };return map[code]||code;
}

// Suggestion + "Load More"
let nextPageToken=null,currentQuery=null;
async function generateTrendBasedSuggestions(originalTitle,append=false){
  if(!originalTitle)return{titles:[],descriptions:[],hashtags:[]};
  if(!append){nextPageToken=null;currentQuery=originalTitle;}
  let url=`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=5&q=${encodeURIComponent(currentQuery)}&order=viewCount`;
  if(append&&nextPageToken)url+=`&pageToken=${nextPageToken}`;
  const resp=await fetchWithAuth(url);
  const json=await resp.json();
  nextPageToken=json.nextPageToken||null;
  const videos=json.items||[];
  const titles=videos.map(v=>v.snippet.title.slice(0,60));
  const descs=videos.map(v=>'ðŸ”¥ '+v.snippet.description.slice(0,150));
  renderSuggestions({titles,descriptions:descs},append);
}
function renderSuggestions(s,append=false){
  if(!append){el('titles').innerHTML='';el('descriptions').innerHTML='';}
  s.titles.forEach(t=>{
    const b=document.createElement('button');b.textContent=t;b.className='btn-inline';
    b.onclick=()=>{selectedTitle=t;updatePrediction();updateButtons(el('titles'),b);};
    el('titles').appendChild(b);
  });
  s.descriptions.forEach(d=>{
    const b=document.createElement('button');b.textContent=d;b.className='btn-inline';
    b.onclick=()=>{selectedDescription=d;updatePrediction();updateButtons(el('descriptions'),b);};
    el('descriptions').appendChild(b);
  });
  let load=el('loadMoreBtn');
  if(!load){
    load=document.createElement('button');load.id='loadMoreBtn';load.textContent='Load More';load.className='btn-inline';load.style.marginTop='10px';
    load.onclick=loadMoreSuggestions;el('descriptions').parentNode.appendChild(load);
  }
  load.style.display=nextPageToken?'inline-block':'none';
}
async function loadMoreSuggestions(){if(nextPageToken&&currentQuery)await generateTrendBasedSuggestions(currentQuery,true);}

let selectedTitle=null,selectedDescription=null;
async function updatePrediction(){
  if(!selectedTitle||!selectedDescription){el('prediction').innerHTML='Pick a title and description to see predicted performance.';return;}
  el('prediction').innerHTML='Calculating...';
  const q=encodeURIComponent(selectedTitle);
  const resp=await fetchWithAuth(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=5&q=${q}&order=viewCount`);
  const js=await resp.json();const v=js.items||[];
  let avg=0,c=0;
  for(const i of v){if(i.id.videoId){const r=await fetchWithAuth(`https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${i.id.videoId}`);const j=await r.json();if(j.items&&j.items[0]){avg+=parseInt(j.items[0].statistics.viewCount||0);c++;}}}
  avg=c?Math.round(avg/c):0;
  el('prediction').innerHTML=`<strong>Predicted Monthly Views:</strong> ${avg}`;
}

function updateButtons(c,s){Array.from(c.children).forEach(b=>b.classList.remove('btn-selected'));s.classList.add('btn-selected');}
function isShortDuration(iso){const m=iso.match(/PT(?:(\\d+)H)?(?:(\\d+)M)?(?:(\\d+)S)?/);if(!m)return false;const h=parseInt(m[1]||0),mm=parseInt(m[2]||0),s=parseInt(m[3]||0);return h*3600+mm*60+s<=60;}
function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
</script>
</body>
</html>
