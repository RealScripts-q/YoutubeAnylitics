<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Live Viewer â€” Modern (with drag & scale & floating recommendations)</title>

  <!-- Google Identity Services -->
  <meta name="google-signin-client_id" content="901141733729-usvhkcmlf33ndqam6cvnlr35dqep84c6.apps.googleusercontent.com">
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --bg-1: #0d0f12;
      --bg-2: linear-gradient(135deg,#0d0f12,#121215);
      --card: rgba(255,255,255,0.06);
      --accent: #ff3b7a;
      --muted: rgba(255,255,255,0.7);
      --glass-border: rgba(255,255,255,0.08);
    }
    [data-theme="light"]{
      --bg-1: #f2f5f8;
      --bg-2: linear-gradient(135deg,#f2f5f8,#e9eef4);
      --card: rgba(22,28,36,0.03);
      --accent: #ff0066;
      --muted: rgba(0,0,0,0.6);
      --glass-border: rgba(0,0,0,0.06);
      color: #0b1220;
    }

    html,body{
      height:100%;
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg-2);
      color: white;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .app {
      max-width:1200px;
      margin:18px auto;
      padding:18px;
      box-sizing: border-box;
      position:relative;
    }

    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }

    .brand {
      display:flex;
      gap:12px;
      align-items:center;
    }

    .logo {
      width:48px;height:48px;border-radius:10px;
      background:linear-gradient(180deg,#ff6b9e,#ff3b7a);
      display:flex;align-items:center;justify-content:center;font-weight:700;
      box-shadow:0 6px 24px rgba(255,59,122,0.18);
      color:white;
    }

    h1{ margin:0;font-size:20px;}
    p.subtitle{ margin:0;color:var(--muted); font-size:13px;}

    .controls {
      display:flex;gap:10px;align-items:center;
    }

    /* Top small controls */
    .small {
      display:flex;gap:8px;align-items:center;
      background:var(--card);
      padding:8px;border-radius:12px;border:1px solid var(--glass-border);
      box-shadow: 0 6px 18px rgba(2,6,23,0.5);
    }

    .small button {
      background:transparent;border:none;color:inherit;padding:6px 10px;border-radius:8px;cursor:pointer;
    }
    .small .accent {
      background:linear-gradient(90deg,var(--accent),#ff7aa6);
      color:white;padding:6px 10px;font-weight:600;border:none;
    }

    main {
      display:flex;
      gap:20px;
      align-items:flex-start;
    }

    /* left and right columns */
    .left {
      flex: 3;
      min-width:0;
      position:relative;
    }
    .right {
      flex: 1;
      min-width:0;
    }

    /* glass card */
    .card {
      background:var(--card);
      border-radius:14px;
      padding:14px;
      border:1px solid var(--glass-border);
      backdrop-filter: blur(8px) saturate(1.1);
      box-shadow: 0 6px 30px rgba(2,6,23,0.45);
    }

    /* video area */
    .videoWrap {
      display:flex;flex-direction:column;gap:12px;
    }
    .videoFrame {
      width:100%;
      border-radius:12px;
      overflow:hidden;
      background:#000;
      position:relative; /* default static until made absolute in drag mode */
    }
    .videoFrame iframe{ width:100%;height:520px;border:0;display:block; }

    /* stats row */
    .statsRow{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      margin-top:8px;
    }
    .stat {
      flex:1;
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
      display:flex;flex-direction:column;gap:6px;
      min-width:0;
    }
    .stat .label{ font-size:12px;color:var(--muted); }
    .stat .value{ font-size:18px;font-weight:700; transition: all 0.12s ease; }

    .stat .smallNote{ font-size:12px;color:var(--muted); }

    /* channel selector */
    .channelRow{
      display:flex;gap:8px;align-items:center;margin-bottom:12px;
    }
    select, input[type=text]{
      background:transparent;border:1px solid var(--glass-border);padding:8px;border-radius:8px;color:inherit;
      outline:none;
    }
    .btn {
      padding:8px 12px;border-radius:10px;border:none;cursor:pointer;background:var(--accent);color:white;font-weight:600;
    }
    .btn.ghost { background:transparent;border:1px solid var(--glass-border); color:inherit;font-weight:600; }

    /* chat */
    .chatFrame{ width:100%; height:520px;border-radius:10px;border:none; }

    /* speaker row */
    .profile{
      display:flex;gap:8px;align-items:center;
    }
    .avatar{ width:36px;height:36px;border-radius:50%;overflow:hidden;background:#ddd; }
    .avatar img{ width:100%;height:100%;object-fit:cover;display:block; }

    /* small responsive */
    @media (max-width:1000px){
      main{ flex-direction:column; }
      .videoFrame iframe, .chatFrame { height:420px; }
      .stat .value{ font-size:16px; }
    }
    @media (max-width:520px){
      .videoFrame iframe, .chatFrame { height:320px; }
      header{ flex-direction:column; align-items:flex-start; gap:10px; }
      .controls { width:100%; justify-content:space-between; }
    }

    /* subtle animations */
    .pulse {
      animation: pulse 1.6s ease-in-out infinite;
    }
    @keyframes pulse {
      0%{ transform:translateY(0); opacity:1; }
      50%{ transform:translateY(-3px); opacity:0.9;}
      100%{ transform:translateY(0); opacity:1;}
    }

    /* small footer note */
    footer { margin-top:18px; color:var(--muted); font-size:12px; text-align:center; }

    /* --- draggable/float panel & handles --- */
    .floatingPanel {
      position: absolute;
      z-index: 1200;
      width: 320px;
      max-width: 90vw;
      background: linear-gradient(180deg, rgba(20,20,20,0.95), rgba(12,12,12,0.95));
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 8px 36px rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.04);
      color: #fff;
      user-select: none;
    }
    .floatingPanel .title {
      font-weight:700;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;
    }
    .recList { display:flex;flex-direction:column;gap:8px; max-height:360px; overflow:auto; padding-right:6px; }
    .recItem { display:flex; gap:8px; align-items:center; cursor:pointer; padding:6px; border-radius:8px; }
    .recItem:hover { background: rgba(255,255,255,0.03); }
    .recItem img { width:84px; height:48px; object-fit:cover; border-radius:6px; flex-shrink:0; }
    .recItem .meta { display:flex;flex-direction:column; gap:4px; min-width:0; }
    .recItem .meta .title { font-size:13px; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .recItem .meta .ch { font-size:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* move handle when draggable enabled */
    .drag-handle {
      display:inline-block;padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:grab;
    }

    /* scale handles (circular) */
    .scale-handle {
      width:14px;height:14px;border-radius:50%;background:rgba(255,255,255,0.85);box-shadow:0 2px 6px rgba(0,0,0,0.4);
      position:absolute; z-index:1300; display:none; touch-action:none;
    }
    .scale-handle.show { display:block; }
    .scale-handle.top { left:50%; transform:translate(-50%,-50%); top:-8px; cursor:n-resize; }
    .scale-handle.bottom { left:50%; transform:translate(-50%,50%); bottom:-8px; cursor:s-resize; }
    .scale-handle.left { top:50%; transform:translate(-50%,-50%); left:-8px; cursor:w-resize; }
    .scale-handle.right { top:50%; transform:translate(50%,-50%); right:-8px; cursor:e-resize; }

    /* when element becomes absolute for dragging */
    .floating, .abs-pos {
      position:absolute !important;
      z-index:1100;
      touch-action:none;
    }

    /* visual outline while dragging/scaling */
    .dragging-outline { outline: 2px dashed rgba(255,255,255,0.12); border-radius:8px; }

  </style>
</head>
<body>
  <div class="app" id="appRoot" data-theme="dark">
    <header>
      <div class="brand">
        <div class="logo">YT</div>
        <div>
          <h1>YouTube Live Viewer</h1>
          <p class="subtitle">Live video left â€¢ chat right â€¢ saved sign-in â€¢ nice UI</p>
        </div>
      </div>

      <div class="controls">
        <div class="small" id="signinBox">
          <div id="g_id_onload"
               data-client_id="901141733729-usvhkcmlf33ndqam6cvnlr35dqep84c6.apps.googleusercontent.com"
               data-context="signin"
               data-callback="onGoogleSignIn"
               data-auto_prompt="false"></div>
          <div class="g_id_signin" data-type="standard"></div>
        </div>

        <div class="small" id="signedInfo" style="display:none;">
          <div class="profile">
            <div class="avatar" id="userAvatar"><img alt="user" src="" /></div>
            <div style="min-width:120px;">
              <div id="userName" style="font-weight:600;font-size:13px;"></div>
              <div style="font-size:12px;color:var(--muted);" id="userEmail"></div>
            </div>
          </div>
          <button class="small btn ghost" id="logoutBtn">Logout</button>
        </div>
      </div>
    </header>

    <main>
      <!-- LEFT -->
      <div class="left">
        <div class="card">
          <div class="channelRow">
            <select id="channelSelect" style="min-width:220px;">
              <option value="">â€” Choose saved channel â€”</option>
            </select>
            <input id="liveIdInput" type="text" placeholder="YouTube Live ID or URL (paste)" style="flex:1;" />
            <button class="btn" id="loadBtn">Load</button>
            <button class="btn ghost" id="saveChannelBtn">+ Save</button>
          </div>

          <div class="videoWrap">
            <div class="videoFrame" id="videoFrame" data-elem="video">
              <iframe id="liveVideo" allow="autoplay; encrypted-media" src=""></iframe>
              <!-- scale handles for video -->
              <div class="scale-handle top" data-handle="top" data-for="videoFrame"></div>
              <div class="scale-handle bottom" data-handle="bottom" data-for="videoFrame"></div>
              <div class="scale-handle left" data-handle="left" data-for="videoFrame"></div>
              <div class="scale-handle right" data-handle="right" data-for="videoFrame"></div>
            </div>

            <div class="statsRow" id="statsRow">
              <div class="stat">
                <div class="label">Views</div>
                <div class="value" id="views">0</div>
                <div class="smallNote">Total video views</div>
              </div>
              <div class="stat">
                <div class="label">Watching Now</div>
                <div class="value" id="watching">0</div>
                <div class="smallNote">Concurrent viewers</div>
              </div>
              <div class="stat">
                <div class="label">Live For</div>
                <div class="value" id="duration">--:--:--</div>
                <div class="smallNote">Time since start</div>
              </div>
              <div class="stat">
                <div class="label">Likes</div>
                <div class="value" id="likes">0</div>
                <div class="smallNote">Total likes</div>
              </div>
              <div class="stat">
                <div class="label">Chat Rate</div>
                <div class="value" id="chatRate">0 / min</div>
                <div class="smallNote">Messages per minute</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="right">
        <div class="card" style="display:flex;flex-direction:column;height:100%;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <div style="font-weight:700;">Live Chat</div>
            <div style="display:flex;gap:8px;align-items:center;">
              <label style="font-size:13px;color:var(--muted);">Theme</label>
              <button id="themeToggle" class="btn ghost">ðŸŒ™</button>
            </div>
          </div>

          <div id="chatWrapper" style="position:relative;">
            <iframe id="liveChat" class="chatFrame" src=""></iframe>
            <!-- scale handles for chat -->
            <div class="scale-handle top" data-handle="top" data-for="chatWrapper"></div>
            <div class="scale-handle bottom" data-handle="bottom" data-for="chatWrapper"></div>
            <div class="scale-handle left" data-handle="left" data-for="chatWrapper"></div>
            <div class="scale-handle right" data-handle="right" data-for="chatWrapper"></div>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px;align-items:center;justify-content:space-between;">
            <div style="color:var(--muted);font-size:13px;">Chat updates every 5s â€¢ Stats UI updates every 0.1s</div>
            <div style="display:flex;gap:8px;">
              <button class="btn ghost" id="addMsgsBtn">Clear saved channels</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer>
      Note: API key and client id are used client-side. For production move requests to a backend.
    </footer>

    <!-- Floating recommendations panel (default placed top-right) -->
    <div id="recPanel" class="floatingPanel" style="right:18px; top:110px;">
      <div class="title">
        <div>Recommended Live Streams</div>
        <div style="display:flex;gap:6px;">
          <div class="drag-handle" id="recDragHint">â ¿</div>
          <button id="closeRec" class="btn ghost" title="Close">âœ•</button>
        </div>
      </div>
      <div id="recList" class="recList">
        <div style="color:var(--muted);font-size:13px;">No stream loaded â€” recommendations will appear after you load a live stream.</div>
      </div>

      <!-- scale handles for recPanel -->
      <div class="scale-handle top" data-handle="top" data-for="recPanel"></div>
      <div class="scale-handle bottom" data-handle="bottom" data-for="recPanel"></div>
      <div class="scale-handle left" data-handle="left" data-for="recPanel"></div>
      <div class="scale-handle right" data-handle="right" data-for="recPanel"></div>
    </div>

  </div>

<script>
/* -------------------------
   Configuration
------------------------- */
const CLIENT_ID = "901141733729-usvhkcmlf33ndqam6cvnlr35dqep84c6.apps.googleusercontent.com";
const API_KEY = "AIzaSyCT0iOHCTHWYrLBSs2A-Th_jQK85pWsg40";

/* -------------------------
   App state & caches
------------------------- */
let LIVE_ID = "";
let statsCache = { views:0, watching:0, likes:0, startTime:null };
let chatTimestamps = [];
let chatPageToken = null;
let chatPollingInterval = null;
let videoStatsInterval = null;
let uiUpdateInterval = null;

/* -------------------------
   Helpers
------------------------- */
function parseLiveId(input){
  if(!input) return "";
  input = input.trim();
  try{
    const url = new URL(input);
    const v = url.searchParams.get('v');
    if(v) return v;
    if(url.hostname.includes('youtu.be')) return url.pathname.replace('/','');
    const parts = url.pathname.split('/');
    return parts.pop() || parts.pop();
  }catch(e){ return input; }
}

function formatTime(seconds){
  const h = String(Math.floor(seconds/3600)).padStart(2,'0');
  const m = String(Math.floor((seconds%3600)/60)).padStart(2,'0');
  const s = String(seconds%60).padStart(2,'0');
  return `${h}:${m}:${s}`;
}

/* -------------------------
   UI refs
------------------------- */
const liveVideo = document.getElementById('liveVideo');
const liveChat = document.getElementById('liveChat');
const loadBtn = document.getElementById('loadBtn');
const saveChannelBtn = document.getElementById('saveChannelBtn');
const liveIdInput = document.getElementById('liveIdInput');
const channelSelect = document.getElementById('channelSelect');
const viewsEl = document.getElementById('views');
const watchingEl = document.getElementById('watching');
const durationEl = document.getElementById('duration');
const likesEl = document.getElementById('likes');
const chatRateEl = document.getElementById('chatRate');
const recPanel = document.getElementById('recPanel');
const recList = document.getElementById('recList');
const closeRec = document.getElementById('closeRec');

/* -------------------------
   Local storage helpers
------------------------- */
function saveToLocal(key,value){ localStorage.setItem(key, JSON.stringify(value)); }
function loadFromLocal(key,fallback=null){ try{ const v = JSON.parse(localStorage.getItem(key)); return v===null?fallback:v; }catch(e){ return fallback; } }

/* -------------------------
   Saved channels
------------------------- */
function loadSavedChannels(){
  const saved = loadFromLocal('yt_saved_channels', []);
  populateChannelSelect(saved);
}
function populateChannelSelect(list){
  channelSelect.innerHTML = '<option value="">â€” Choose saved channel â€”</option>';
  list.forEach(item=>{
    const opt = document.createElement('option');
    opt.value = item.id;
    opt.textContent = `${item.title || item.id} â€” ${item.id}`;
    channelSelect.appendChild(opt);
  });
}
function addSavedChannel(id,title){
  if(!id) return;
  const list = loadFromLocal('yt_saved_channels', []);
  if(list.find(x=>x.id===id)) return alert('Channel already saved');
  list.push({id,title:title||id});
  saveToLocal('yt_saved_channels',list);
  populateChannelSelect(list);
}

/* -------------------------
   Channel selector events
------------------------- */
channelSelect.addEventListener('change', ()=>{
  const val = channelSelect.value;
  if(val){
    liveIdInput.value = val;
    startViewing(val);
  }
});

/* -------------------------
   Load / Save / Clear
------------------------- */
loadBtn.addEventListener('click', ()=>{
  const id = parseLiveId(liveIdInput.value);
  if(!id) return alert('Enter a live ID or paste a YouTube URL.');
  startViewing(id);
});

saveChannelBtn.addEventListener('click', async ()=>{
  if(!LIVE_ID) return alert('Load a live first.');
  try{
    const info = await fetchVideoInfo(LIVE_ID);
    const title = (info?.snippet?.title) || LIVE_ID;
    addSavedChannel(LIVE_ID,title);
    alert('Saved channel: ' + title);
  }catch(e){
    console.warn(e);
    addSavedChannel(LIVE_ID,LIVE_ID);
    alert('Saved id: ' + LIVE_ID);
  }
});

closeRec.addEventListener('click', ()=> recPanel.style.display='none');

/* -------------------------
   Video & chat polling
------------------------- */
async function startViewing(newId){
  stopPolling();
  LIVE_ID = newId;

  // set iframe srcs
  liveVideo.src = `https://www.youtube.com/embed/${LIVE_ID}?autoplay=1`;
  liveChat.src = `https://www.youtube.com/live_chat?v=${LIVE_ID}&embed_domain=${location.hostname}`;

  // reset caches
  chatTimestamps = [];
  chatPageToken = null;
  statsCache = { views:0, watching:0, likes:0, startTime:null };

  const info = await fetchVideoInfo(LIVE_ID);
  if(!info){ alert('Could not load video info â€” ensure the ID is correct and the video is accessible.'); return; }

  const liveDetails = info.liveStreamingDetails || {};
  const liveChatId = liveDetails.activeLiveChatId || null;
  if(!liveChatId) console.warn('No activeLiveChatId found; chat rate will be N/A.');

  await updateStatsFromVideoInfo(info);

  videoStatsInterval = setInterval(fetchAndUpdateVideoStats,15000);
  chatPollingInterval = setInterval(()=>{ if(liveChatId) fetchChatMessages(liveChatId); },5000);
  uiUpdateInterval = setInterval(updateStatDisplay,100);

  // show recommended panel directly under live chat
  recPanel.style.display='block';
  fetchRecommendedLiveStreams(info?.snippet?.title || '');
}

async function fetchVideoInfo(videoId){
  const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,liveStreamingDetails&id=${videoId}&key=${API_KEY}`;
  try{
    const res = await fetch(url);
    const json = await res.json();
    if(json.items?.length>0) return json.items[0];
    return null;
  }catch(e){ console.error('fetchVideoInfo', e); return null; }
}

async function updateStatsFromVideoInfo(info){
  const stats = info.statistics || {};
  const live = info.liveStreamingDetails || {};
  statsCache.views = Number(stats.viewCount||0);
  statsCache.likes = Number(stats.likeCount||0);
  statsCache.watching = Number(live.concurrentViewers||0);
  statsCache.startTime = live.actualStartTime ? new Date(live.actualStartTime) : null;
}

async function fetchAndUpdateVideoStats(){
  if(!LIVE_ID) return;
  try{ const info = await fetchVideoInfo(LIVE_ID); if(info) await updateStatsFromVideoInfo(info); }catch(e){ console.error(e); }
}

async function fetchChatMessages(liveChatId){
  const base = `https://www.googleapis.com/youtube/v3/liveChat/messages?part=snippet,authorDetails&liveChatId=${encodeURIComponent(liveChatId)}&key=${API_KEY}&maxResults=200`;
  const url = chatPageToken ? base+'&pageToken='+chatPageToken : base;
  try{
    const res = await fetch(url);
    const json = await res.json();
    if(!json) return;
    chatPageToken = json.nextPageToken || null;
    const items = json.items || [];
    const now = Date.now();
    items.forEach(item=>{
      const t = item.snippet?.publishedAt ? new Date(item.snippet.publishedAt).getTime() : now;
      chatTimestamps.push(t);
    });
    chatTimestamps = chatTimestamps.filter(ts=>ts>=Date.now()-60000);
  }catch(e){ console.error(e); }
}

function computeChatRate(){ return chatTimestamps.filter(ts=>ts>=Date.now()-60000).length; }

function updateStatDisplay(){
  viewsEl.innerText = statsCache.views.toLocaleString();
  watchingEl.innerText = statsCache.watching.toLocaleString();
  likesEl.innerText = statsCache.likes.toLocaleString();
  durationEl.innerText = statsCache.startTime ? formatTime(Math.floor((Date.now()-statsCache.startTime.getTime())/1000)) : '--:--:--';
  chatRateEl.innerText = computeChatRate() + ' / min';
}

function stopPolling(){
  if(videoStatsInterval){ clearInterval(videoStatsInterval); videoStatsInterval=null; }
  if(chatPollingInterval){ clearInterval(chatPollingInterval); chatPollingInterval=null; }
  if(uiUpdateInterval){ clearInterval(uiUpdateInterval); uiUpdateInterval=null; }
}

/* -------------------------
   Recommended live streams
------------------------- */
async function fetchRecommendedLiveStreams(title){
  if(!title){ recList.innerHTML='<div>No title for recommendations</div>'; return; }
  recList.innerHTML='<div>Loading recommended live streamsâ€¦</div>';
  try{
    const q = encodeURIComponent(title+' live');
    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&eventType=live&q=${q}&key=${API_KEY}&maxResults=8`;
    const res = await fetch(url);
    const json = await res.json();
    if(!json?.items?.length){ recList.innerHTML='<div>No live recommendations found</div>'; return; }
    recList.innerHTML='';
    json.items.forEach(it=>{
      const vid=it.id.videoId;
      const snip=it.snippet||{};
      const thumb=(snip.thumbnails?.medium?.url || snip.thumbnails?.default?.url) || '';
      const titleText = snip.title || vid;
      const channel = snip.channelTitle || '';
      const item = document.createElement('div');
      item.className='recItem';
      item.innerHTML = `<img src="${thumb}" alt="thumb" /><div class="meta"><div class="title">${escapeHtml(titleText)}</div><div class="ch">${escapeHtml(channel)} â€¢ Live</div></div>`;
      item.addEventListener('click', ()=> { liveIdInput.value=vid; startViewing(vid); });
      recList.appendChild(item);
    });
  }catch(e){ console.error(e); recList.innerHTML='<div>Error fetching recommendations</div>'; }
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>

</body>
</html>
